#cloud-config
write_files:
  - path: /etc/envoy/envoy.yaml
    content: |
      node:
        cluster: envoy-cluster
        id: envoy-node-1

      dynamic_resources:
        ads_config:
          api_type: GRPC
          transport_api_version: V3
          grpc_services:
          - envoy_grpc:
              cluster_name: xds_cluster
        cds_config:
          resource_api_version: V3
          ads: {}
        lds_config:
          resource_api_version: V3
          ads: {}

      static_resources:
        clusters:
        - name: xds_cluster
          type: STATIC
          connect_timeout: 1s
          load_assignment:
            cluster_name: xds_cluster
            endpoints:
            - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: ${control_plane_host}
                      port_value: 18000
          typed_extension_protocol_options:
            envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
              "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
              explicit_http_config:
                http2_protocol_options: {}

      admin:
        address:
          socket_address:
            address: 0.0.0.0
            port_value: 9901

packages:
  - docker.io

runcmd:
  - systemctl start docker
  - systemctl enable docker
  - docker run -d --name envoy --network host -v /etc/envoy:/etc/envoy envoyproxy/envoy:v1.31-latest
